<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ZAMA • FHEVM — Partner Tariff Gate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
  <style>
    :root{ --bg:#0b0f1a; --bg2:#090e18; --ink:#eaf1ff; --muted:#b6c4e3; --card:#0f1728; --br:#1a2540; --glow:rgba(56,189,248,.18); --accent:#2f66ff; --accent-2:#2553e6; --ok:#7ef29a; --bad:#ff8b8b; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; color:var(--ink);
      background: radial-gradient(60% 40% at 50% -10%, #0f1a33 0%, transparent 70%), linear-gradient(180deg, var(--bg2) 0%, var(--bg) 100%);
      font:15px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;}
    .wrap{max-width:1180px; margin:30px auto; padding:0 18px; display:grid; gap:18px; grid-template-columns: 1.1fr .9fr}
    .spacer{flex:1} .pill{padding:6px 10px; border:1px solid var(--br); border-radius:10px; background:linear-gradient(to bottom, rgba(255,255,255,.03), transparent 30%), linear-gradient(150deg, #182033, #060a16); color:#cfe0ff; font-weight:800; white-space:nowrap}
    .title{font-size:22px; font-weight:900}
    .card{border:1px solid var(--br); border-radius:16px; background:radial-gradient(circle at top center, var(--glow) 0, rgba(15,23,42,.96) 36%, #020617 70%); box-shadow:0 1px 0 rgba(15,23,42,.9), 0 28px 60px rgba(0,0,0,.8), 0 0 36px var(--glow);}    
    .card .hd{padding:14px 16px; border-bottom:1px solid var(--br); display:flex; align-items:center; gap:10px}
    .card .bd{padding:14px 16px;}
    .grid{display:grid; gap:12px} .grid.cols-2{grid-template-columns:1fr 1fr}
    label{font-size:12px; color:#9db1e8; text-transform:uppercase; letter-spacing:.06em; font-weight:800; display:block; margin-bottom:6px}
    input{width:100%; padding:12px; border-radius:12px; border:1px solid var(--br); background:#0b1220; color:var(--ink); font-weight:800; outline:none}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:42px; padding:10px 14px; border-radius:12px; border:1px solid rgba(31,41,55,.9); color:var(--ink); font-weight:900; cursor:pointer; background:linear-gradient(to bottom, rgba(255,255,255,.06), transparent 32%), linear-gradient(145deg, #1f2933, #020617); box-shadow:0 0 0 1px rgba(15,23,42,.9), 0 14px 30px rgba(0,0,0,.7), 0 0 26px var(--glow);}    
    .btn:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(15,23,42,1), 0 18px 40px rgba(0,0,0,.85), 0 0 30px rgba(56,189,248,.35)}
    .btn[disabled]{opacity:.55; cursor:not-allowed} .btn.primary{background:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%); box-shadow:0 14px 40px rgba(47,102,255,.28), inset 0 0 0 1px rgba(255,255,255,.05)}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:8px; align-items:center}
    .mono{font-family:ui-monospace, Menlo, Consolas, 'Courier New', monospace} .muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)}
    .sep{height:1px; background:var(--br); margin:8px 0} .footer{grid-column:1/-1; text-align:center; color:#9db1e8; opacity:.85; padding:8px}
    .row-actions{display:flex; gap:10px; flex-wrap:wrap}
    .result-box{padding:10px 12px; border:1px solid var(--br); border-radius:12px; background:linear-gradient(to bottom, rgba(255,255,255,.03), transparent 32%), linear-gradient(145deg, #132035, #020617);}    
    .tag{display:inline-block; padding:2px 8px; border-radius:10px; border:1px solid var(--br); background:#0b1424; color:#cfe0ff; font-size:12px; font-weight:800}
    .row-split{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center} .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="hd">
        <div class="title">Partner Tariff Gate</div>
        <span class="pill">ZAMA · FHEVM</span>
        <span class="spacer"></span>
        <span class="pill" id="net-pill">Network: —</span>
        <button class="btn" id="btn-connect">Connect</button>
      </div>
      <div class="bd grid">
        <div class="card">
          <div class="hd"><b>Eligibility · Encrypted user input</b></div>
          <div class="bd grid">
            <div class="result-box" id="decisionBox">Decision: <span class="tag">n/a</span></div>

            <div class="grid cols-2">
              <div><label>Plan ID</label><input id="planId" type="number" min="1" value="1" /></div>
              <div></div>
              <div><label>KYC level (u8)</label><input id="kyc" type="number" min="0" max="255" value="3" /></div>
              <div><label>Tenure days (u16)</label><input id="tenure" type="number" min="0" max="65535" value="45" /></div>
              <div><label>Trade volume (u32)</label><input id="volume" type="number" min="0" max="4294967295" value="1500" /></div>
              <div style="display:flex;align-items:flex-end;justify-content:flex-end">
                <button class="btn primary" id="btn-eval">Encrypt &amp; Evaluate</button>
              </div>
            </div>

            <div>
              <label>Handle</label>
              <div class="row-split">
                <input id="handleOut" class="mono small" readonly placeholder="—" />
                <button class="btn" id="btn-copy">Copy</button>
              </div>
            </div>

            <div class="row-actions">
              <button class="btn" id="btn-make-public">Make my decision public</button>
              <button class="btn" id="btn-public-decrypt">Decrypt (public)</button>
              <button class="btn" id="btn-user-decrypt">Decrypt (signed)</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><b>Admin · Set encrypted policy</b> <span class="pill" id="isOwnerPill" style="margin-left:8px">owner: —</span></div>
          <div class="bd grid cols-2">
            <div><label>Plan ID</label><input id="p-plan" type="number" min="1" value="1" /></div>
            <div><label>minKycLevel (u8)</label><input id="p-kyc" type="number" min="0" max="255" value="2" /></div>
            <div><label>minTenureDays (u16)</label><input id="p-tenure" type="number" min="0" max="65535" value="30" /></div>
            <div><label>minTradeVolumeUsd (u32)</label><input id="p-volume" type="number" min="0" max="4294967295" value="1000" /></div>
            <div><label>minPassRules (u8)</label><input id="p-pass" type="number" min="1" max="3" value="2" /></div>
            <div style="display:flex;align-items:flex-end"><button class="btn" id="btn-set-policy">Set encrypted policy</button></div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd"><b>Contract</b></div>
      <div class="bd grid">
        <div class="kv"><div class="muted">Address:</div><div class="mono" id="caddr">—</div></div>
        <div class="kv"><div class="muted">Owner:</div><div class="mono" id="cowner">—</div></div>
        <div class="kv"><div class="muted">Relayer:</div><div id="relayerState">not ready</div></div>
        <div class="sep"></div>
        <div class="kv"><div class="muted">Your account:</div><div class="mono" id="acc">—</div></div>
        <div class="kv"><div class="muted">Eligibility handle:</div><div class="mono" id="lastHandle">—</div></div>
      </div>
    </aside>

    <div class="footer">ZAMA FHEVM · Partner Tariff Gate — Single-file demo (Sepolia)</div>
  </div>

  <script type="module">
    // ===== Net & endpoints =====
    const CONTRACT_ADDRESS = '0x7F658EDaddFC0dfb8a68021dD8855d1B34a36CC3';
    const CHAIN_ID_HEX = '0xaa36a7';

    // Try to use local reverse-proxy if available, else direct Zama endpoints
    const ORIGIN = window.location.origin;
    const HAS_LOCAL_PROXY = ORIGIN.includes('localhost:3443') || ORIGIN.includes('127.0.0.1:3443');
    const RELAYER_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/relayer` : 'https://relayer.testnet.zama.org';
    const GATEWAY_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/gateway` : 'https://gateway.testnet.zama.org';

    const $ = (q)=>document.querySelector(q);
    const btnConnect=$('#btn-connect'), netPill=$('#net-pill'), isOwnerPill=$('#isOwnerPill');
    const caddrEl=$('#caddr'), cownerEl=$('#cowner'), accEl=$('#acc'), relayerStateEl=$('#relayerState');
    const planIdEl=$('#planId'), kycEl=$('#kyc'), tenureEl=$('#tenure'), volumeEl=$('#volume'), btnEval=$('#btn-eval');
    const decisionBox=$('#decisionBox'), handleOut=$('#handleOut'), btnCopy=$('#btn-copy');
    const btnMakePublic=$('#btn-make-public'), btnPublicDecrypt=$('#btn-public-decrypt'), btnUserDecrypt=$('#btn-user-decrypt');
    const pPlanEl=$('#p-plan'), pKycEl=$('#p-kyc'), pTenureEl=$('#p-tenure'), pVolEl=$('#p-volume'), pPassEl=$('#p-pass'), btnSetPolicy=$('#btn-set-policy');
    const lastHandleEl=$('#lastHandle');

    const [{ BrowserProvider, Contract }, relayerSdk] = await Promise.all([
      import('https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm'),
      import('https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js')
    ]);
    const { initSDK, createInstance, SepoliaConfig, generateKeypair } = relayerSdk;
    await initSDK();

    const IS_HTTPS = location.protocol === 'https:';
    if(!IS_HTTPS){ relayerStateEl.innerHTML = '<span class="bad">not https (signed decrypt disabled)</span>'; btnUserDecrypt.disabled = true; }

    const ABI = [
      { inputs:[], stateMutability:'view', type:'function', name:'owner', outputs:[{type:'address'}] },
      { inputs:[{name:'planId',type:'uint256'}], stateMutability:'view', type:'function', name:'hasPolicy', outputs:[{type:'bool'}] },
      { inputs:[{name:'planId',type:'uint256'},{name:'kycLevelExt',type:'bytes32'},{name:'tenureDaysExt',type:'bytes32'},{name:'volumeUsdExt',type:'bytes32'},{name:'proof',type:'bytes'}], name:'evaluateEligibilityEncrypted', outputs:[{type:'bytes32'}], stateMutability:'nonpayable', type:'function' },
      { inputs:[{name:'planId',type:'uint256'},{name:'minKycLevelExt',type:'bytes32'},{name:'minTenureDaysExt',type:'bytes32'},{name:'minTradeVolumeUsdExt',type:'bytes32'},{name:'minPassRulesExt',type:'bytes32'},{name:'proof',type:'bytes'}], name:'setPolicyEncrypted', outputs:[], stateMutability:'nonpayable', type:'function' },
      { inputs:[{name:'planId',type:'uint256'}], name:'getMyEligibilityHandle', outputs:[{type:'bytes32'}], stateMutability:'view', type:'function' },
      { inputs:[{name:'planId',type:'uint256'}], name:'makeMyEligibilityPublic', outputs:[], stateMutability:'nonpayable', type:'function' }
    ];

    let provider=null, signer=null, contract=null, relayer=null;
    let currentAccount=null, ownerAddr=null;

    const tag=(t,ok)=>`<span class="tag ${ok?'ok':'bad'}">${t}</span>`;
    const setDecision=(txt,ok=null)=>{
      if(ok===true) decisionBox.innerHTML=`Decision: ${tag('ELIGIBLE',true)} <span class="muted small">(${txt})</span>`;
      else if(ok===false) decisionBox.innerHTML=`Decision: ${tag('NOT ELIGIBLE',false)} <span class="muted small">(${txt})</span>`;
      else decisionBox.innerHTML='Decision: <span class="tag">n/a</span>';
    };
    const short=(a)=>a?a.slice(0,6)+'…'+a.slice(-4):'—';

    async function ensureSepolia(){
      const id = await window.ethereum.request({ method:'eth_chainId' });
      netPill.textContent = 'Network: ' + (id||'—');
      if(id?.toLowerCase()!==CHAIN_ID_HEX){
        try{ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: CHAIN_ID_HEX }] }); }catch(e){}
      }
      const now = await window.ethereum.request({ method:'eth_chainId' });
      netPill.textContent = 'Network: ' + (now||'—');
    }

    async function connect(){
      if(!window.ethereum?.request){ alert('Install MetaMask'); return; }
      await window.ethereum.request({ method:'eth_requestAccounts' });
      await ensureSepolia();

      provider = new BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      currentAccount = await signer.getAddress();
      accEl.textContent = short(currentAccount);

      contract = new Contract(CONTRACT_ADDRESS, ABI, signer);
      caddrEl.textContent = CONTRACT_ADDRESS;

      try{ ownerAddr = await contract.owner(); cownerEl.textContent = short(ownerAddr); }
      catch{ ownerAddr = null; cownerEl.textContent = '—'; }
      isOwnerPill.textContent = 'owner: ' + (ownerAddr && currentAccount && ownerAddr.toLowerCase()===currentAccount.toLowerCase() ? 'yes' : 'no');

      relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, gatewayUrl: GATEWAY_URL, network: window.ethereum, debug: true });
      relayerStateEl.textContent = 'ready' + (IS_HTTPS ? '' : ' (limited)') + (HAS_LOCAL_PROXY ? ' (proxy)' : '');
      btnConnect.textContent = 'Disconnect';
    }

    function disconnect(){
      provider=signer=contract=relayer=null; currentAccount=null;
      accEl.textContent='—'; btnConnect.textContent='Connect'; relayerStateEl.textContent='not ready';
      setDecision(''); lastHandleEl.textContent='—'; handleOut.value='';
    }

    btnConnect.addEventListener('click', async()=>{ if(signer) disconnect(); else await connect(); });
    btnCopy.addEventListener('click', async()=>{ if(!handleOut.value) return; await navigator.clipboard.writeText(handleOut.value); btnCopy.textContent='Copied'; setTimeout(()=>btnCopy.textContent='Copy',900); });

    // ===== Helpers for decrypt =====
    function normalizePublicDecryptResult(out, handleHex){
      if(Array.isArray(out)){
        const first = out[0];
        return typeof first === 'string' ? first : (first?.value ?? null);
      }
      if(out && typeof out==='object'){
        const k = handleHex?.toLowerCase?.();
        const v = out[handleHex] ?? out[k];
        return (typeof v==='object' && v!==null && 'value' in v) ? v.value : v;
      }
      return null;
    }

    async function smartDecrypt(handleHex, mode='auto'){
      if(!relayer || !contract) throw new Error('Connect wallet first');
      const pair = { handle: String(handleHex), contractAddress: CONTRACT_ADDRESS };

      // 1) public (pairs)
      if(mode==='auto' || mode==='public'){
        try{
          const out = await relayer.publicDecrypt([pair]);
          const v = normalizePublicDecryptResult(out, String(handleHex));
          if(v!=null) return BigInt(v)===1n;
        }catch(e){ if(mode==='public') throw e; }

        // 2) public (handles only)
        try{
          const out2 = await relayer.publicDecrypt([String(handleHex)]);
          const v2 = normalizePublicDecryptResult(out2, String(handleHex));
          if(v2!=null) return BigInt(v2)===1n;
        }catch(e){ if(mode==='public') throw e; }
      }

      // 3) signed userDecrypt
      if(mode!=='public'){
        if(!IS_HTTPS) throw new Error('Open over HTTPS to use signed decrypt');
        const kp = await generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const daysValid = '7';
        const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, daysValid);
        const sig = await signer.signTypedData(eip.domain, { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification }, eip.message);
        const out = await relayer.userDecrypt(
          [pair],
          kp.privateKey, kp.publicKey, sig.replace('0x',''),
          [CONTRACT_ADDRESS], await signer.getAddress(), startTs, daysValid
        );
        const picked = out[String(handleHex)] ?? out[String(handleHex).toLowerCase()];
        if(picked==null) throw new Error('userDecrypt returned empty');
        return BigInt(picked)===1n;
      }

      throw new Error('Decrypt failed');
    }

    // === Encrypt & Evaluate (NO auto-decrypt earlier; now we auto-try) ===
    btnEval.addEventListener('click', async()=>{
      try{
        if(!signer || !contract || !relayer) throw new Error('Connect wallet first');
        const planId = BigInt(planIdEl.value||'0');
        const kyc = Number(kycEl.value||'0')|0;
        const tenure = Number(tenureEl.value||'0')|0;
        const volume = Number(volumeEl.value||'0')|0;
        if(planId<=0n) throw new Error('Bad planId');

        setDecision('encrypting …');
        const enc = relayer.createEncryptedInput(CONTRACT_ADDRESS, currentAccount);
        enc.add8(kyc); enc.add16(tenure); enc.add32(volume);
        const { handles, inputProof } = await enc.encrypt();

        const tx = await contract.evaluateEligibilityEncrypted(planId, handles[0], handles[1], handles[2], inputProof);
        await tx.wait();

        const h = await contract.getMyEligibilityHandle(planId);
        handleOut.value = h; lastHandleEl.textContent = h;

        // AUTO decrypt cascade right after evaluation
        try{
          const ok = await smartDecrypt(h, 'auto');
          setDecision('auto decrypt', ok);
        }catch(e){ setDecision('stored handle — use buttons to decrypt'); }
      }catch(e){ console.error(e); alert(e?.message||'Failed'); setDecision('error'); }
    });

    // Make public (on-chain)
    btnMakePublic.addEventListener('click', async()=>{
      try{
        if(!signer || !contract) throw new Error('Connect wallet first');
        const planId = BigInt(planIdEl.value||'0');
        const tx = await contract.makeMyEligibilityPublic(planId);
        await tx.wait();
        const h = await contract.getMyEligibilityHandle(planId);
        handleOut.value = h; lastHandleEl.textContent = h;
        setDecision('made public — now try Decrypt (public)');
      }catch(e){ console.error(e); alert(e?.message||'Failed'); }
    });

    // === Replaced handlers: use smartDecrypt ===
    btnPublicDecrypt.addEventListener('click', async()=>{
      try{
        const planId = BigInt(planIdEl.value||'0');
        const h = handleOut.value || await contract.getMyEligibilityHandle(planId);
        if(!h || String(h)==='0x'+'0'.repeat(64)) throw new Error('No decision handle. Evaluate first.');
        const ok = await smartDecrypt(String(h), 'public');
        setDecision('public decrypt', ok);
      }catch(e){ console.error('public decrypt failed:', e); alert(e?.message||'Public decrypt failed'); setDecision('error'); }
    });

    btnUserDecrypt.addEventListener('click', async()=>{
      try{
        const planId = BigInt(planIdEl.value||'0');
        const h = handleOut.value || await contract.getMyEligibilityHandle(planId);
        if(!h || String(h)==='0x'+'0'.repeat(64)) throw new Error('No decision handle');
        const ok = await smartDecrypt(String(h), 'signed');
        setDecision('signed decrypt', ok);
      }catch(e){ console.error(e); alert(e?.message||'Failed'); }
    });

    // === Admin: set encrypted policy ===
    btnSetPolicy.addEventListener('click', async()=>{
      try{
        if(!signer || !contract || !relayer) throw new Error('Connect wallet first');
        if(!ownerAddr || ownerAddr.toLowerCase()!== (await signer.getAddress()).toLowerCase()) throw new Error('Owner only');
        const planId = BigInt(pPlanEl.value||'0');
        const a=Number(pKycEl.value||'0')|0, b=Number(pTenureEl.value||'0')|0, c=Number(pVolEl.value||'0')|0, d=Number(pPassEl.value||'0')|0;
        if(planId<=0n) throw new Error('Bad planId');

        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, await signer.getAddress());
        buf.add8(a); buf.add16(b); buf.add32(c); buf.add8(d);
        const { handles, inputProof } = await buf.encrypt();

        const tx = await contract.setPolicyEncrypted(planId, handles[0], handles[1], handles[2], handles[3], inputProof);
        await tx.wait(); alert('Policy set ✓');
      }catch(e){ console.error(e); alert(e?.message||'Failed'); }
    });

    if(window.ethereum){
      window.ethereum.on?.('accountsChanged', ()=>location.reload());
      window.ethereum.on?.('chainChanged', ()=>location.reload());
      try{ const a = await window.ethereum.request({ method:'eth_accounts' }); if(a && a.length) await connect(); }catch{}
    }
  </script>
</body>
</html>
